name: Update Clash Subscription

on:
  workflow_dispatch:

  # 设置定时任务，使用 cron 语法
  # '0 */6 * * *' 表示每隔 6 小时执行一次 (在 0 分, 每 6 小时)
  schedule:
    - cron: '0 */6 * * *'

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml

      - name: Run subscription update script
        run: python update_subscription.py

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          # 使用 git add -A 来暂存所有变动（包括新建和修改的文件）
          git add -A
          # 检查工作区是否有变动，如果有，则创建 commit
          # [skip ci] 是为了防止这个 commit 再次触发工作流程，避免无限循环
          git diff-index --quiet HEAD || git commit -m "feat: 自动更新订阅文件" -m "更新时间: $(date -u)" -m "[skip ci]"
          # 将变动推送到远程仓库
          git push
