name: Update Clash Subscription

on:
  workflow_dispatch:

  # 设置定时任务，使用 cron 语法
  # '0 */6 * * *' 表示每隔 6 小时执行一次 (在 0 分, 每 6 小时)
  schedule:
    - cron: '0 */6 * * *'

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml

      # 实现真实延迟测试
      - name: Download and setup Xray-core
        run: |
          # 从 GitHub Releases 下载最新的 Xray-core for Linux 64-bit
          wget -O xray.zip https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
          # 解压出 xray 可执行文件
          unzip xray.zip xray
          # 赋予可执行权限
          chmod +x xray
          # 清理压缩包
          rm xray.zip

      # 执行 Python 脚本来更新订阅
      # 脚本会自动调用同目录下的 xray 程序
      - name: Run subscription update script
        run: python update_subs.py

      # 提交并推送更改
      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add -A
          git diff-index --quiet HEAD || git commit -m "feat: 自动更新订阅文件" -m "更新时间: $(date -u)" -m "[skip ci]"
          git push
